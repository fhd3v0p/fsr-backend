#!/bin/bash

# FSR Deployment Script
# –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e

echo "üöÄ FSR Deployment Script"
echo "=========================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ "$1" = "bot" ]; then
    echo "üì¶ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Telegram Bot..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
    echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
    systemctl stop fsr-bot fsr-api
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è git)
    if [ -d ".git" ]; then
        echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ git..."
        git pull
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip3 install -r requirements.txt
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
    echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
    systemctl start fsr-bot fsr-api
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
    sleep 5
    systemctl status fsr-bot fsr-api --no-pager -l
    
    echo "‚úÖ Telegram Bot —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç!"

elif [ "$1" = "web" ]; then
    echo "üåê –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Flutter Web App..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Flutter —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if ! command -v flutter &> /dev/null; then
        echo "‚ùå Flutter –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Flutter –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ."
        exit 1
    fi
    
    # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    echo "üî® –°–æ–±–∏—Ä–∞–µ–º Flutter Web App..."
    flutter build web --release
    
    # –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
    scp -r build/web/* root@46.203.233.218:/var/www/html/
    
    echo "‚úÖ Flutter Web App —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç!"

elif [ "$1" = "full" ]; then
    echo "üîÑ –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
    
    # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ–º –±–æ—Ç–∞
    $0 bot
    
    # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    $0 web
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã
    echo "üè• –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã..."
    ssh root@46.203.233.218 "cd /root/telegram_bot && python3 health_check.py"
    
    echo "‚úÖ –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

elif [ "$1" = "monitor" ]; then
    echo "üìä –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
    ssh root@46.203.233.218 "cd /root/telegram_bot && python3 system_monitor.py"

elif [ "$1" = "logs" ]; then
    echo "üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤..."
    ssh root@46.203.233.218 "tail -f /root/telegram_bot/system_monitor.log"

elif [ "$1" = "status" ]; then
    echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
    ssh root@46.203.233.218 "systemctl status fsr-bot fsr-api nginx --no-pager -l"

elif [ "$1" = "restart" ]; then
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
    ssh root@46.203.233.218 "systemctl restart fsr-bot fsr-api nginx"
    echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã!"

else
    echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
    echo ""
    echo "üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  $0 bot     - –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ Telegram Bot"
    echo "  $0 web     - –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ Flutter Web App"
    echo "  $0 full    - –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
    echo "  $0 monitor - –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
    echo "  $0 logs    - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
    echo "  $0 status  - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤"
    echo "  $0 restart - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    echo ""
    echo "üí° –ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 bot     # –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞"
    echo "  $0 full    # –û–±–Ω–æ–≤–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É"
    echo "  $0 status  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
fi 